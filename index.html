<!--
    SPDX-FileCopyrightText: Â© 2025 William Dugann <https://github.com/dugann>
    SPDX-License-Identifier: LicenseRef-Proprietary

    OPEN CURB
    ------------------------------------
    This application is intended for the use of the general public, or those working with the public who might be helped by it.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Open Curb</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#003B71">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- HTML5-QRCode Library for Barcode Scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0"
            }
        }
    </script>

    <style>
        :root {
            --indy-blue: #003B71;
            --indy-red: #D11241;
            --indy-white: #FFFFFF;
            --indy-sky: #E1E8F0;
        }
        
        body {
            background-color: var(--indy-blue);
            color: white;
            margin: 0;
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: auto; 
        }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        @supports (padding-top: env(safe-area-inset-top)) {
            .safe-top { padding-top: env(safe-area-inset-top); }
            .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        }
        
        /* Barcode Scanner Overlay Styles */
        #reader {
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
        }
        #reader video {
            object-fit: cover;
            border-radius: 1rem;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- PWA Service Worker Registration -->
    <script>
        // Only attempt registration if the protocol supports it (http/https), ignoring blob: or file:
        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration skipped:', err.message));
            });
        }
    </script>

    <!-- The React Application -->
    <script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { createRoot } from 'react-dom/client';
import { 
    Search, MapPin, Navigation, Info, X, ChevronLeft, ChevronRight, Star, 
    RotateCw, AlertTriangle, CheckCircle, User, ExternalLink, Copy, Download, 
    Map as MapIcon, CloudOff, Share2, Link as LinkIcon, History, Trash2, 
    Camera, Moon, Sun, Settings, ArrowLeft, BookmarkPlus, Bookmark,
    Wifi, WifiOff, Zap, Clock, Loader2, ScanBarcode, FileText
} from 'lucide-react';

// ============================================================================
// CONSTANTS & CONFIG
// ============================================================================

const CONFIG = {
    BACKEND_URL: "https://indy-locator-exchange.onrender.com",
    ETIMS_ENDPOINT: "https://prodpci.etimspayments.com/pbw/inputAction.doh",
    // Pointing to secure backend proxy.
    SNAPSHOT_PROXY_URL: "https://indy-locator-exchange.onrender.com/api/proxy/lpr", 
    STORAGE_KEYS: {
        STREETS: "opencurb_streets_data",
        META: "opencurb_meta_check",
        FAVORITES: "opencurb_favorites",
        RECENT: "opencurb_recent_searches",
        THEME: "opencurb_theme",
        SETTINGS: "opencurb_settings"
    },
    CACHE_DURATION: 24 * 60 * 60 * 1000, // 24 hours
    MAX_RECENT: 10,
    MAX_FAVORITES: 20,
    REQUEST_TIMEOUT: 30000,
    RETRY_ATTEMPTS: 3,
    RETRY_DELAY: 1000
};

const US_STATES = [
    "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", 
    "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", 
    "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", 
    "VT", "VA", "WA", "WV", "WI", "WY"
];

// ============================================================================
// UTILITIES & HOOKS (Standard)
// ============================================================================

function luhn_checksum(code) {
    let len = code.length;
    let parity = len % 2;
    let sum = 0;
    for (let i = len-1; i >= 0; i--) {
        let d = parseInt(code.charAt(i));
        if (i % 2 === parity) { d *= 2; }
        if (d > 9) { d -= 9; }
        sum += d;
    }
    return sum % 10;
}

function luhnValidate(fullcode) {
    return luhn_checksum(fullcode) === 0;
}

function vibrate(pattern = 10) {
    if ('vibrate' in navigator) {
        navigator.vibrate(pattern);
    }
}

async function fetchWithTimeout(url, options = {}, timeout = CONFIG.REQUEST_TIMEOUT) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    
    try {
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        clearTimeout(id);
        return response;
    } catch (error) {
        clearTimeout(id);
        throw error;
    }
}

async function fetchWithRetry(url, options = {}, retries = CONFIG.RETRY_ATTEMPTS) {
    for (let i = 0; i < retries; i++) {
        try {
            return await fetchWithTimeout(url, options);
        } catch (error) {
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (i + 1)));
        }
    }
}

// Storage helpers
const storage = {
    get: (key, defaultValue = null) => {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch {
            return defaultValue;
        }
    },
    set: (key, value) => {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch {
            return false;
        }
    },
    remove: (key) => {
        try {
            localStorage.removeItem(key);
            return true;
        } catch {
            return false;
        }
    }
};

// ============================================================================
// DYNAMIC STYLES
// ============================================================================

const customStyles = `
    @keyframes pulse-ring {
        0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.3); }
        70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
        100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }

    @keyframes slideInUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @keyframes slideInDown {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes shimmer {
        0% { background-position: -468px 0; }
        100% { background-position: 468px 0; }
    }

    .circle-transition {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 128px;
        height: 128px;
        background-color: #E1E8F0;
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
        pointer-events: none;
        z-index: 25;
    }

    .circle-transition.expanding {
        opacity: 1;
        transform: translate(-50%, -50%) scale(25);
        transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.1s ease-in;
    }
    
    .circle-transition.closing {
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.5s cubic-bezier(0.5, 0, 0.75, 0);
    }
    
    .fade-enter { opacity: 0; transform: translateY(10px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        75% { transform: translateX(4px); }
    }
    
    .shake-input { 
        animation: shake 0.3s ease-in-out; 
        border-color: #D11241 !important; 
    }

    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .slide-in-up {
        animation: slideInUp 0.3s ease-out;
    }

    .slide-in-down {
        animation: slideInDown 0.3s ease-out;
    }

    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }

    /* Pull to refresh styles */
    .ptr-element {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        pointer-events: none;
        z-index: 100;
    }

    /* Dark mode */
    .dark {
        --indy-blue: #001f3f;
        --indy-sky: #1a2332;
    }

    .dark body {
        background-color: var(--indy-blue);
    }
`;

// ============================================================================
// ICONS
// ============================================================================

const GoogleDirectionsIcon = ({ size = 20, className = "" }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className} xmlns="http://www.w3.org/2000/svg">
        <path d="M21.71 11.29l-9-9c-.39-.39-1.02-.39-1.41 0l-9 9c-.39.39-.39 1.02 0 1.41l9 9c.39.39 1.02.39 1.41 0l9-9c.39-.38.39-1.01 0-1.41zM14 14.5V12h-4v3H8v-4c0-.55.45-1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/>
    </svg>
);

const GooglePegmanIcon = ({ size = 20, className = "" }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className} xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C9.5 2 7.5 4 7.5 6.5C7.5 8.7 9.1 10.5 11.15 10.9V22H12.85V16H14.5V22H16.2V10.9C18.25 10.5 19.85 8.7 19.85 6.5C19.85 4 17.85 2 15.35 2H12ZM12 4H15.35C16.75 4 17.85 5.1 17.85 6.5C17.85 7.9 16.75 9 15.35 9C14.85 9 14.4 8.85 14 8.6V7H12V8.6C11.6 8.85 11.15 9 10.65 9C9.25 9 8.15 7.9 8.15 6.5C8.15 5.1 9.25 4 10.65 4H12Z"/>
    </svg>
);

// ============================================================================
// HOOKS
// ============================================================================

function useOnlineStatus() {
    const [isOnline, setIsOnline] = useState(navigator.onLine);
    
    useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        
        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);
    
    return isOnline;
}

function useFavorites() {
    const [favorites, setFavorites] = useState(() => 
        storage.get(CONFIG.STORAGE_KEYS.FAVORITES, [])
    );
    
    const addFavorite = useCallback((item) => {
        setFavorites(prev => {
            const updated = [item, ...prev.filter(f => f.id !== item.id)].slice(0, CONFIG.MAX_FAVORITES);
            storage.set(CONFIG.STORAGE_KEYS.FAVORITES, updated);
            return updated;
        });
    }, []);
    
    const removeFavorite = useCallback((id) => {
        setFavorites(prev => {
            const updated = prev.filter(f => f.id !== id);
            storage.set(CONFIG.STORAGE_KEYS.FAVORITES, updated);
            return updated;
        });
    }, []);
    
    const isFavorite = useCallback((id) => {
        return favorites.some(f => f.id === id);
    }, [favorites]);
    
    return { favorites, addFavorite, removeFavorite, isFavorite };
}

function useRecentSearches() {
    const [recent, setRecent] = useState(() => 
        storage.get(CONFIG.STORAGE_KEYS.RECENT, [])
    );
    
    const addRecent = useCallback((search) => {
        setRecent(prev => {
            const updated = [
                { ...search, timestamp: Date.now() },
                ...prev.filter(s => s.query !== search.query)
            ].slice(0, CONFIG.MAX_RECENT);
            storage.set(CONFIG.STORAGE_KEYS.RECENT, updated);
            return updated;
        });
    }, []);
    
    const clearRecent = useCallback(() => {
        setRecent([]);
        storage.remove(CONFIG.STORAGE_KEYS.RECENT);
    }, []);
    
    return { recent, addRecent, clearRecent };
}

// ============================================================================
// COMPONENTS
// ============================================================================

const LoadingSkeleton = () => (
    <div className="space-y-4 p-4">
        {[1, 2, 3].map(i => (
            <div key={i} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-300 slide-in-up" style={{ animationDelay: `${i * 0.1}s` }}>
                <div className="flex gap-4">
                    <div className="flex-1 space-y-3">
                        <div className="skeleton h-6 w-3/4 rounded"></div>
                        <div className="skeleton h-4 w-1/2 rounded"></div>
                        <div className="skeleton h-16 w-full rounded-xl"></div>
                        <div className="flex gap-2">
                            <div className="skeleton h-10 w-24 rounded-lg"></div>
                            <div className="skeleton h-10 w-24 rounded-lg"></div>
                        </div>
                    </div>
                    <div className="skeleton w-36 h-36 rounded-2xl"></div>
                </div>
            </div>
        ))}
    </div>
);

const EmptyState = ({ message, icon: Icon, action }) => (
    <div className="flex flex-col items-center justify-center py-16 px-6 text-center fade-in">
        <div className="bg-white/5 rounded-full p-6 mb-4">
            <Icon size={48} className="text-white/40" />
        </div>
        <p className="text-white/60 text-sm mb-4">{message}</p>
        {action && action}
    </div>
);

const Toast = ({ message, type = 'info', onClose }) => {
    useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
    }, [onClose]);
    
    const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
    
    return (
        <div className={`fixed top-20 left-1/2 -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-lg z-50 slide-in-down flex items-center gap-2`}>
            {type === 'success' && <CheckCircle size={18} />}
            {type === 'error' && <AlertTriangle size={18} />}
            {type === 'info' && <Info size={18} />}
            <span className="font-medium">{message}</span>
        </div>
    );
};

const ResultItem = ({ item, onFavorite, isFavorite }) => {
    const [copied, setCopied] = useState(false);

    let centroid = null;
    let mainActionUrl = '#';
    let navigateUrl = '#';
    let streetViewUrl = '#';

    if (item.geoms && item.geoms.length > 0) {
        const total = item.geoms.length;
        const avgX = item.geoms.reduce((sum, g) => sum + g.x, 0) / total;
        const avgY = item.geoms.reduce((sum, g) => sum + g.y, 0) / total;
        centroid = { x: avgX, y: avgY };

        const sortedGeoms = [...item.geoms].sort((a, b) => parseInt(a.id) - parseInt(b.id));
        
        if (sortedGeoms.length > 1) {
            const first = sortedGeoms[0];
            const last = sortedGeoms[sortedGeoms.length - 1];
            const intermediates = sortedGeoms.slice(1, -1);
            const waypoints = intermediates
                .slice(0, 20) 
                .map(g => `${g.y},${g.x}`)
                .join('|');

            mainActionUrl = `https://www.google.com/maps/dir/?api=1&origin=${first.y},${first.x}&destination=${last.y},${last.x}&waypoints=${waypoints}&travelmode=walking`;
        } else {
            mainActionUrl = `https://www.google.com/maps/search/?api=1&query=${centroid.y},${centroid.x}`;
        }

        navigateUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.address + ', Indianapolis, IN')}`;
        streetViewUrl = `https://www.google.com/maps?q=&layer=c&cbll=${centroid.y},${centroid.x}`;
    }

    const handleCopy = () => {
        try {
            const text = item.ids.join(', ');
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            setCopied(true);
            vibrate([10, 50, 10]);
            setTimeout(() => setCopied(false), 2000);
        } catch (err) {
            console.error('Copy failed', err);
        }
    };

    const handleShare = async () => {
        if (!navigator.share) return;
        const ids = item.ids.join('-');
        const shareUrl = `${window.location.origin}${window.location.pathname}?q=${ids}`;
        const title = `Parking at ${item.address}`;
        const text = `Check out parking meters ${item.ids.join(', ')} at ${item.address}`;

        try {
            await navigator.share({ title, text, url: shareUrl });
        } catch (err) { console.log('Share dismissed'); }
    };

    const handleFavoriteClick = () => {
        vibrate(10);
        onFavorite({ 
            id: item.ids.join('-'), 
            address: item.address, 
            ids: item.ids,
            geoms: item.geoms 
        });
    };

    return (
        <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-300 mb-4 hover:shadow-lg transition-all slide-in-up">
            <div className="flex flex-col-reverse sm:flex-row gap-4">
                
                <div className="flex-1 min-w-0 flex flex-col justify-between">
                    <div>
                        <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                                <h3 className="font-bold text-[#003B71] text-lg leading-tight text-black truncate pr-2">{item.address}</h3>
                                <p className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mt-0.5">Indianapolis, IN</p>
                            </div>
                            <button 
                                onClick={handleFavoriteClick}
                                className="ml-2 p-2 rounded-full hover:bg-gray-100 transition-colors active:scale-95"
                                aria-label={isFavorite ? "Remove from favorites" : "Add to favorites"}
                            >
                                {isFavorite ? 
                                    <Bookmark size={20} className="text-yellow-500 fill-yellow-500" /> : 
                                    <BookmarkPlus size={20} className="text-gray-400" />
                                }
                            </button>
                        </div>

                        <div className="bg-[#003B71]/5 rounded-xl p-2 mb-3 border border-[#003B71]/10 relative group w-fit max-w-full">
                            <div className="flex items-center justify-between mb-1 px-1 gap-4">
                                <span className="text-[10px] uppercase font-bold text-[#003B71]/70">Meter IDs</span>
                                <div className="flex gap-2">
                                    {navigator.share && (
                                        <button onClick={handleShare} className="flex items-center gap-1 bg-white border border-[#003B71]/20 px-2 py-0.5 rounded text-[10px] font-bold text-[#003B71] hover:bg-[#003B71]/5 transition-colors active:scale-95">
                                            <Share2 size={12} /> Share
                                        </button>
                                    )}
                                    <button onClick={handleCopy} className="flex items-center gap-1 bg-white border border-[#003B71]/20 px-2 py-0.5 rounded text-[10px] font-bold text-[#003B71] hover:bg-[#003B71]/5 transition-colors active:scale-95">
                                        {copied ? <CheckCircle size={12} className="text-green-600"/> : <Copy size={12} />}
                                        {copied ? 'Copied' : 'Copy'}
                                    </button>
                                </div>
                            </div>
                            <div className="flex overflow-x-auto gap-2 pb-1 hide-scroll">
                                {item.ids.map(id => (
                                    <span key={id} className="inline-flex items-center justify-center bg-white border border-[#003B71]/20 rounded-md px-2 py-1 text-sm font-mono font-bold text-[#003B71] whitespace-nowrap shadow-sm min-w-[3rem]">
                                        {id}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="flex flex-wrap gap-3 mt-auto">
                        <a 
                            href={navigateUrl}
                            target="_blank" 
                            rel="noreferrer"
                            className="flex items-center justify-center gap-1.5 bg-white text-[#003B71] border border-[#003B71]/30 py-1.5 px-3 rounded-lg text-[10px] sm:text-xs font-bold active:scale-95 transition-all hover:bg-[#003B71] hover:text-white"
                        >
                            <GoogleDirectionsIcon size={16} /> Navigate
                        </a>
                        <a 
                            href={streetViewUrl}
                            target="_blank" 
                            rel="noreferrer"
                            className={`flex items-center justify-center gap-1.5 bg-white text-[#003B71] border border-[#003B71]/30 py-1.5 px-3 rounded-lg text-[10px] sm:text-xs font-bold active:scale-95 transition-all hover:bg-[#003B71] hover:text-white ${!centroid && 'opacity-50 pointer-events-none'}`}
                        >
                            <GooglePegmanIcon size={16} /> Street View
                        </a>
                    </div>
                </div>

                <div className="w-full sm:w-36 flex-shrink-0 flex flex-col gap-2">
                     <a 
                        href={mainActionUrl}
                        target="_blank"
                        rel="noreferrer"
                        className="w-full h-24 sm:h-36 bg-gray-100 rounded-2xl overflow-hidden border-2 border-white shadow-md relative group block bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-100 to-gray-200"
                    >
                        <div className="w-full h-full flex flex-col items-center justify-center text-[#003B71]/30 group-hover:text-[#003B71]/50 transition-colors">
                            <MapIcon size={36} strokeWidth={1.5} />
                        </div>
                        
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <MapPin className="text-[#D11241] fill-[#D11241] drop-shadow-lg transform -translate-y-1" size={32} />
                        </div>
                        
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center">
                            <ExternalLink size={20} className="text-[#003B71] opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-md bg-white/80 p-1 rounded-full" />
                        </div>
                    </a>
                    <div className="bg-[#003B71] text-white text-[10px] font-bold py-1.5 rounded-lg text-center tracking-wide uppercase shadow-sm">
                        {item.ids.length} {item.ids.length === 1 ? 'Unit' : 'Units'}
                    </div>
                </div>
            </div>
        </div>
    );
};

const RecentSearchItem = ({ search, onSelect, onRemove }) => (
    <button 
        onClick={() => onSelect(search)}
        className="w-full flex items-center justify-between p-3 bg-white/5 hover:bg-white/10 rounded-xl transition-colors group"
    >
        <div className="flex items-center gap-3 flex-1 min-w-0">
            <Clock size={16} className="text-white/40 flex-shrink-0" />
            <div className="text-left flex-1 min-w-0">
                <p className="text-white font-medium text-sm truncate">{search.query}</p>
                <p className="text-white/40 text-xs">{search.mode === 'id' ? 'Meter ID' : 'Street Name'}</p>
            </div>
        </div>
        <button 
            onClick={(e) => {
                e.stopPropagation();
                onRemove(search);
            }}
            className="p-1 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white/10 rounded"
        >
            <X size={16} className="text-white/60" />
        </button>
    </button>
);

const FavoriteItem = ({ favorite, onSelect, onRemove }) => (
    <button 
        onClick={() => onSelect(favorite)}
        className="w-full flex items-center justify-between p-3 bg-white/5 hover:bg-white/10 rounded-xl transition-colors group"
    >
        <div className="flex items-center gap-3 flex-1 min-w-0">
            <Star size={16} className="text-yellow-500 fill-yellow-500 flex-shrink-0" />
            <div className="text-left flex-1 min-w-0">
                <p className="text-white font-medium text-sm truncate">{favorite.address}</p>
                <p className="text-white/40 text-xs">{favorite.ids.length} {favorite.ids.length === 1 ? 'meter' : 'meters'}</p>
            </div>
        </div>
        <button 
            onClick={(e) => {
                e.stopPropagation();
                onRemove(favorite.id);
            }}
            className="p-1 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white/10 rounded"
        >
            <X size={16} className="text-white/60" />
        </button>
    </button>
);

// --- BARCODE SCANNER COMPONENT ---
const BarcodeScannerModal = ({ onClose, onDetected }) => {
    const scannerRef = useRef(null);
    
    useEffect(() => {
        // Initialize HTML5 QR Code Scanner for barcodes (Code 128, etc. typical for tickets)
        const html5QrCode = new Html5Qrcode("reader");
        scannerRef.current = html5QrCode;
        
        // Config optimized for barcode reading
        const config = { 
            fps: 10, 
            qrbox: { width: 280, height: 150 }, 
            aspectRatio: 1.0,
            formatsToSupport: [ 
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.UPC_A
            ]
        };
        
        html5QrCode.start(
            { facingMode: "environment" }, 
            config,
            (decodedText) => {
                vibrate([50]);
                onDetected(decodedText);
                html5QrCode.stop().then(onClose).catch(console.error);
            },
            (errorMessage) => { /* scanning */ }
        ).catch(err => {
            console.error("Error starting scanner", err);
        });

        return () => {
            if (scannerRef.current && scannerRef.current.isScanning) {
                scannerRef.current.stop().catch(console.error);
            }
        };
    }, []);

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm fade-in">
            <div className="w-full max-w-md bg-white rounded-3xl overflow-hidden relative">
                <button onClick={onClose} className="absolute top-4 right-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70"><X size={24}/></button>
                <div id="reader" className="w-full h-64 bg-black"></div>
                <div className="p-4 text-center">
                    <p className="text-[#003B71] font-bold">Scan Ticket Barcode</p>
                    <p className="text-gray-500 text-xs mt-1">Align the barcode within the frame</p>
                </div>
            </div>
        </div>
    );
};

export default function App() {
    const [isCitationMode, setIsCitationMode] = useState(false);
    const [mode, setMode] = useState('id'); 
    const [view, setView] = useState('search');
    const [loading, setLoading] = useState(false);
    const [isExpanding, setIsExpanding] = useState(false);
    const [copyFeedback, setCopyFeedback] = useState(null);
    const [isScanning, setIsScanning] = useState(false); 
    const [showBarcodeScanner, setShowBarcodeScanner] = useState(false); // NEW Barcode State
    
    const [streets, setStreets] = useState([]);
    const [dataDate, setDataDate] = useState(null);
    
    const [startId, setStartId] = useState('');
    const [endId, setEndId] = useState('');
    const [streetQuery, setStreetQuery] = useState('');
    
    const [ticketNum, setTicketNum] = useState('');
    const [plateState, setPlateState] = useState('IN');
    const [plateNum, setPlateNum] = useState('');

    const [results, setResults] = useState([]);
    const [error, setError] = useState(null);
    const [shakeField, setShakeField] = useState(null);
    const [showInfoModal, setShowInfoModal] = useState(false);
    const [showSettingsModal, setShowSettingsModal] = useState(false);
    const [toast, setToast] = useState(null);

    // PWA Install State
    const [installPrompt, setInstallPrompt] = useState(null);
    const [isStandalone, setIsStandalone] = useState(false);
    
    // Custom hooks
    const isOnline = useOnlineStatus();
    const { favorites, addFavorite, removeFavorite, isFavorite } = useFavorites();
    const { recent, addRecent, clearRecent } = useRecentSearches();

    const formRef = useRef(null);
    const fileInputRef = useRef(null);

    const showToast = useCallback((message, type = 'info') => {
        setToast({ message, type });
    }, []);

    // Reusable search function with better error handling
    const executeSearch = async (searchMode, sId, eId, sQuery) => {
        if (!isOnline) {
            setError("No internet connection");
            vibrate([10, 100, 10]);
            return;
        }

        setLoading(true);
        setError(null);

        try {
            const params = new URLSearchParams({ mode: searchMode });
            if (searchMode === 'id') {
                params.append('start', sId);
                if (eId) params.append('end', eId);
            } else {
                params.append('street', sQuery);
            }
            
            const res = await fetchWithRetry(`${CONFIG.BACKEND_URL}/api/search?${params}`);
            
            if (!res.ok) {
                throw new Error(`Server error: ${res.status}`);
            }
            
            const data = await res.json();
            
            if (!data.features || data.features.length === 0) {
                setResults([]);
                setLoading(false);
                setError("No parking assets found.");
                vibrate([10, 100, 10]);
            } else {
                const groups = {};
                data.features.forEach(f => {
                    const rawAddr = f.attributes.FULL_ADDRESS;
                    const addr = rawAddr ? rawAddr.trim() : "Unknown Location";
                    if (!groups[addr]) groups[addr] = { ids: [], geoms: [] };
                    groups[addr].ids.push(f.attributes.SPACE_NUMBER);
                    if (f.geometry && f.geometry.x && f.geometry.y) {
                        groups[addr].geoms.push({ 
                            id: f.attributes.SPACE_NUMBER, 
                            x: f.geometry.x, 
                            y: f.geometry.y 
                        });
                    }
                });
                
                const resultList = Object.keys(groups).sort().map(addr => ({
                    address: addr,
                    ids: groups[addr].ids.sort((a,b) => a-b),
                    geoms: groups[addr].geoms
                }));
                
                setResults(resultList);
                setIsExpanding(true);
                
                // Add to recent searches
                addRecent({
                    query: searchMode === 'id' ? `${sId}${eId ? `-${eId}` : ''}` : sQuery,
                    mode: searchMode
                });
                
                vibrate(10);
                setTimeout(() => {
                    setView('results');
                    setLoading(false);
                }, 400); 
            }
        } catch (e) {
            console.error('Search error:', e);
            if (e.name === 'AbortError') {
                setError("Request timed out. Try again.");
            } else {
                setError("Connection failed. Check your internet.");
            }
            setLoading(false);
            vibrate([10, 100, 10, 100, 10]);
        }
    };

    // Camera Handlers
    const handleCameraClick = () => {
        if (fileInputRef.current) {
            fileInputRef.current.click();
        }
    };

    const handleImageUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        setIsScanning(true);
        setError(null);
        vibrate(10);

        const formData = new FormData();
        formData.append('upload', file);
        formData.append('regions', 'us'); // Optimize for US plates

        try {
            // Using direct fetch instead of proxy to debug CORS locally if needed
            // NOTE: In production, switch this back to CONFIG.SNAPSHOT_PROXY_URL
            const response = await fetch(CONFIG.SNAPSHOT_PROXY_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                 // Try to parse the error details from JSON
                 let errorDetails = {};
                 try {
                    errorDetails = await response.json();
                 } catch(e) {
                    // fall back to text if json parse fails
                 }
                 
                 console.error('LPR API Error Details:', response.status, errorDetails);
                 
                 // Handle specific 502/403 (Token missing) case
                 if (response.status === 502 && errorDetails.details && errorDetails.details.includes('403')) {
                     throw new Error('Backend LPR Token Invalid');
                 }

                 // NEW: Specific handling for 404 (Endpoint not found)
                 if (response.status === 404) {
                     throw new Error('LPR Endpoint not found on server');
                 }
                 throw new Error('API Error');
            }

            const data = await response.json();

            if (data.results && data.results.length > 0) {
                const bestMatch = data.results[0];
                const plate = bestMatch.plate.toUpperCase();
                
                setPlateNum(plate);
                
                // Try to map region to state code if available
                if (bestMatch.region && bestMatch.region.code) {
                     const regionCode = bestMatch.region.code.split('-').pop().toUpperCase();
                     if (US_STATES.includes(regionCode)) {
                         setPlateState(regionCode);
                     }
                }

                showToast(`Plate detected: ${plate}`, 'success');
                vibrate([10, 50, 10]);
            } else {
                setError("No license plate detected. Try again.");
                vibrate([10, 100, 10]);
            }
        } catch (err) {
            console.error("LPR Error:", err);
            // Show toast based on error type
            if (err.message === 'Backend LPR Token Invalid') {
                showToast("Backend API Token missing (403)", "error");
            } else if (err.message.includes('Endpoint not found')) {
                showToast("Server update required (404)", "error");
            } else {
                setError("Failed to scan plate. Please enter manually.");
            }
            vibrate([10, 100, 10]);
        } finally {
            setIsScanning(false);
            // Reset input so same file can be selected again if needed
            event.target.value = null;
        }
    };

    const handleBarcodeDetected = (code) => {
        setTicketNum(code);
        showToast(`Ticket scanned: ${code}`, 'success');
    };

    // Citation share/copy logic
    const getCitationShareData = () => {
        let shareUrl = window.location.origin + window.location.pathname;
        let text = "";
        
        if (mode === 'ticket' && ticketNum) {
            shareUrl += `?ticket=${ticketNum}`;
            text = `Pay citation #${ticketNum}: ${shareUrl}`;
        } else if (mode === 'plate' && plateNum) {
            shareUrl += `?plate=${plateNum}&state=${plateState}`;
            text = `Pay citations for ${plateState} plate ${plateNum}: ${shareUrl}`;
        }
        return { shareUrl, text };
    };

    const handleCitationShare = async () => {
        const { shareUrl, text } = getCitationShareData();
        if (!text) return;

        if (navigator.share) {
            try {
                await navigator.share({ title: "Open Curb Citation", text: text, url: shareUrl });
                vibrate(10);
            } catch (err) { console.log('Share dismissed'); }
        } else {
            handleCitationCopy();
        }
    };

    const handleCitationCopy = async () => {
        const { text } = getCitationShareData();
        if (!text) return;
        
        try {
            await navigator.clipboard.writeText(text);
            setCopyFeedback("Copied!");
            vibrate([10, 50, 10]);
            setTimeout(() => setCopyFeedback(null), 2000);
        } catch (err) {
            console.error("Copy failed");
        }
    };

    // Effects
    useEffect(() => {
        const handleInstallPrompt = (e) => { 
            e.preventDefault(); 
            setInstallPrompt(e); 
        };
        
        const handleAppInstalled = () => { 
            setInstallPrompt(null); 
            showToast('App installed successfully!', 'success');
        };
        
        const checkStandalone = () => {
             const isStandaloneMode = window.matchMedia('(display-mode: standalone)').matches 
                || window.navigator.standalone 
                || document.referrer.includes('android-app://');
             setIsStandalone(isStandaloneMode);
        };
        
        const handleShareTarget = () => {
            const params = new URLSearchParams(window.location.search);
            const query = params.get('share_text') || params.get('q') || params.get('text');
            const ticketParam = params.get('ticket');
            const plateParam = params.get('plate');
            const stateParam = params.get('state');

            if (ticketParam) {
                 setIsCitationMode(true); 
                 setMode('ticket'); 
                 setTicketNum(ticketParam);
                 window.history.replaceState({}, document.title, window.location.pathname);
                 return;
            }
            
            if (plateParam) {
                 setIsCitationMode(true); 
                 setMode('plate'); 
                 setPlateNum(plateParam);
                 if (stateParam) setPlateState(stateParam);
                 window.history.replaceState({}, document.title, window.location.pathname);
                 return;
            }
            
            if (query) {
                const match = query.match(/\b\d{3,6}\b/);
                if (match) {
                    const foundId = match[0];
                    setMode('id'); 
                    setStartId(foundId); 
                    setIsCitationMode(false);
                    executeSearch('id', foundId, '', '');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        };

        window.addEventListener('beforeinstallprompt', handleInstallPrompt);
        window.addEventListener('appinstalled', handleAppInstalled);
        checkStandalone();
        handleShareTarget();
        
        const mediaQuery = window.matchMedia('(display-mode: standalone)');
        try { 
            mediaQuery.addEventListener('change', checkStandalone); 
        } catch (e) { 
            mediaQuery.addListener(checkStandalone); 
        }

        return () => {
            window.removeEventListener('beforeinstallprompt', handleInstallPrompt);
            window.removeEventListener('appinstalled', handleAppInstalled);
            try { 
                mediaQuery.removeEventListener('change', checkStandalone); 
            } catch (e) { 
                mediaQuery.removeListener(checkStandalone); 
            }
        };
    }, []);

    useEffect(() => {
        const checkMeta = async () => {
            try {
                const res = await fetchWithRetry(`${CONFIG.BACKEND_URL}/api/meta`);
                const data = await res.json();
                
                if (data.data?.[0]?.attributes?.modified) {
                    const dateStr = new Date(data.data[0].attributes.modified).toLocaleDateString();
                    setDataDate(dateStr);
                    
                    const cachedMeta = storage.get(CONFIG.STORAGE_KEYS.META);
                    if (cachedMeta?.timestamp < data.data[0].attributes.modified) {
                        storage.remove(CONFIG.STORAGE_KEYS.STREETS);
                    }
                    
                    storage.set(CONFIG.STORAGE_KEYS.META, {
                        timestamp: data.data[0].attributes.modified,
                        displayDate: dateStr
                    });
                }
            } catch (e) {
                console.error("Meta handshake failed.", e);
            }
        };
        checkMeta();
    }, []);

    useEffect(() => {
        if (!isCitationMode && mode === 'street' && streets.length === 0) {
            const loadStreets = async () => {
                const cached = storage.get(CONFIG.STORAGE_KEYS.STREETS);
                if (cached) { 
                    setStreets(cached); 
                    return; 
                }
                
                try {
                    const res = await fetchWithRetry(`${CONFIG.BACKEND_URL}/api/streets`);
                    const sorted = await res.json();
                    storage.set(CONFIG.STORAGE_KEYS.STREETS, sorted);
                    setStreets(sorted);
                } catch (e) {
                    console.error("Street handshake failed", e);
                    showToast('Failed to load street names', 'error');
                }
            };
            loadStreets();
        }
    }, [mode, isCitationMode]);

    // Handlers
    const handleInstallClick = async () => {
        if (!installPrompt) return;
        installPrompt.prompt();
        const { outcome } = await installPrompt.userChoice;
        if (outcome === 'accepted') {
            setInstallPrompt(null);
        }
    };

    const toggleCitationMode = () => {
        setIsCitationMode(!isCitationMode);
        setMode(isCitationMode ? 'id' : 'ticket');
        setError(null); 
        setResults([]); 
        setView('search');
        vibrate(10);
    };

    const handleSearch = async () => {
        setError(null); 
        setShakeField(null);
        
        if (isCitationMode) {
            if (mode === 'ticket') {
                if (!ticketNum) { 
                    setError("Enter a ticket number"); 
                    setShakeField('ticket'); 
                    vibrate([10, 100, 10]);
                    return; 
                }
                if (ticketNum.length !== 9) { 
                    setError("Ticket number must be 9 digits"); 
                    setShakeField('ticket'); 
                    vibrate([10, 100, 10]);
                    return; 
                }
                if (!ticketNum.startsWith('0') && !ticketNum.startsWith('71')) { 
                    setError("Ticket must start with 0 or 71"); 
                    setShakeField('ticket'); 
                    vibrate([10, 100, 10]);
                    return; 
                }
                if (!luhnValidate(ticketNum)) { 
                    setError("Invalid ticket number"); 
                    setShakeField('ticket'); 
                    vibrate([10, 100, 10]);
                    return; 
                }
            } else {
                if (!plateNum) { 
                    setError("Enter a license plate"); 
                    setShakeField('plate'); 
                    vibrate([10, 100, 10]);
                    return; 
                }
            }
            
            vibrate(10);
            formRef.current.submit();
            setTicketNum(''); 
            setPlateNum(''); 
            setPlateState('IN');
            return;
        }
        
        if (mode === 'id') {
            if (!startId) { 
                setError("Please enter a Start ID"); 
                setShakeField('start'); 
                vibrate([10, 100, 10]);
                return; 
            }
            if (startId.length < 3) { 
                setError("Meter ID too short (min 3 digits)"); 
                setShakeField('start'); 
                vibrate([10, 100, 10]);
                return; 
            }
            if (endId && parseInt(endId) <= parseInt(startId)) { 
                setError("End ID must be greater than Start ID"); 
                setShakeField('end'); 
                vibrate([10, 100, 10]);
                return; 
            }
        } else {
            if (!streetQuery || streetQuery.trim().length < 2) { 
                setError("Please select a valid street name"); 
                setShakeField('street'); 
                vibrate([10, 100, 10]);
                return; 
            }
        }
        
        executeSearch(mode, startId, endId, streetQuery);
    };

    const handleNewSearch = () => {
        setIsExpanding(false); 
        vibrate(10);
        setTimeout(() => { 
            setView('search'); 
            setStartId(''); 
            setEndId(''); 
            setStreetQuery(''); 
            setResults([]); 
            setError(null); 
        }, 300);
    };

    const handleNumericInput = (setter) => (e) => {
        const val = e.target.value; 
        if (val === '' || (/^[1-9]\d*$/.test(val))) setter(val);
    };

    const handleTicketInput = (e) => {
        const val = e.target.value.replace(/\D/g,''); 
        setTicketNum(val);
    };

    const handleRecentSelect = (search) => {
        vibrate(10);
        if (search.mode === 'id') {
            const parts = search.query.split('-');
            setStartId(parts[0]);
            setEndId(parts[1] || '');
            setMode('id');
        } else {
            setStreetQuery(search.query);
            setMode('street');
        }
    };

    const handleFavoriteSelect = (favorite) => {
        vibrate(10);
        setResults([favorite]);
        setView('results');
    };

    return (
        <div className="h-screen w-screen relative flex flex-col font-sans text-white">
            <style>{customStyles}</style>

            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* Hidden File Input for Camera */}
            <input 
                type="file" 
                accept="image/*" 
                capture="environment"
                ref={fileInputRef}
                onChange={handleImageUpload}
                className="hidden"
            />

            {/* Barcode Scanner Overlay */}
            {showBarcodeScanner && (
                <BarcodeScannerModal 
                    onClose={() => setShowBarcodeScanner(false)} 
                    onDetected={handleBarcodeDetected} 
                />
            )}

            <form ref={formRef} action={CONFIG.ETIMS_ENDPOINT} method="POST" target="_blank" className="hidden">
                <input type="hidden" name="clientcode" value="5I" />
                <input type="hidden" name="requestType" value="submit" />
                <input type="hidden" name="requestCount" value="1" />
                <input type="hidden" name="clientAccount" value="6" />
                <input type="hidden" name="paymentType" value={mode === 'ticket' ? 'T' : 'P'} />
                <input type="hidden" name="documentNum" value={mode === 'ticket' ? ticketNum : `${plateState}${plateNum}`} />
                <input type="submit" value="Submit" />
            </form>

            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,#003B71_0%,#001f3f_100%)] z-0" />
            <div className="absolute inset-0 opacity-10 pointer-events-none z-0" style={{ backgroundImage: 'linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)', backgroundSize: '40px 40px' }}></div>

            <header className={`relative z-10 safe-top px-6 py-6 grid grid-cols-[1fr_auto_1fr] sm:flex sm:justify-between items-center transition-opacity duration-300 ${view !== 'search' ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                <div className="col-start-2">
                    <button onClick={toggleCitationMode} className="focus:outline-none active:scale-95 transition-transform block">
                        <img src="https://raw.githubusercontent.com/dugann/indy-locator-web/main/logo.png" alt="Open Curb" className="h-12 sm:h-14 w-auto object-contain drop-shadow-md" />
                    </button>
                </div>
                
                <div className="flex gap-2 col-start-3 justify-self-end">
                    {!isOnline && (
                        <div className="p-3 bg-red-500/20 rounded-full animate-pulse" title="Offline">
                            <WifiOff size={24} className="text-red-300" />
                        </div>
                    )}
                    {installPrompt && !isStandalone && (
                        <button onClick={handleInstallClick} className="p-3 bg-white/10 rounded-full hover:bg-white/20 transition-colors slide-in-down" title="Install App">
                            <Download size={24} className="text-white/80" />
                        </button>
                    )}
                    <button 
                        onClick={() => setShowSettingsModal(true)} 
                        className="p-3 bg-white/10 rounded-full hover:bg-white/20 transition-colors"
                        title="Settings"
                    >
                        <Settings size={24} className="text-white/80" />
                    </button>
                </div>
            </header>

            <main className={`flex-1 relative z-10 flex flex-col transition-all duration-300 ${view !== 'search' ? 'opacity-0 pointer-events-none scale-95' : 'opacity-100 scale-100'}`}>
                <div className="mt-4 sm:mt-16 px-6 flex flex-col gap-8 sm:gap-12">
                    <div className="w-full max-w-md mx-auto space-y-4 sm:space-y-6 relative z-10">
                        <div className="flex bg-white/10 p-1.5 sm:p-2 rounded-2xl backdrop-blur-sm border border-white/20">
                            <button 
                                onClick={() => { setMode(isCitationMode ? 'ticket' : 'id'); setError(null); vibrate(10); }} 
                                className={`flex-1 py-4 px-2 sm:px-4 rounded-xl text-sm sm:text-base font-semibold transition-all duration-300 flex items-center justify-center gap-2 ${mode === 'id' || mode === 'ticket' ? 'bg-white/20 text-white shadow-inner' : 'text-white/60 hover:text-white hover:bg-white/5'}`}
                            >
                                {isCitationMode ? 'Ticket #' : 'Meter ID'}
                            </button>
                            <div className="w-[1px] bg-white/10 my-2"></div>
                            <button 
                                onClick={() => { setMode(isCitationMode ? 'plate' : 'street'); setError(null); vibrate(10); }} 
                                className={`flex-1 py-4 px-2 sm:px-4 rounded-xl text-sm sm:text-base font-semibold transition-all duration-300 flex items-center justify-center gap-2 ${mode === 'street' || mode === 'plate' ? 'bg-white/20 text-white shadow-inner' : 'text-white/60 hover:text-white hover:bg-white/5'}`}
                            >
                                {isCitationMode ? 'License Plate' : 'Street Name'}
                            </button>
                        </div>

                        <div className="min-h-[80px] sm:min-h-[120px] flex flex-col justify-center">
                            {!isCitationMode && mode === 'id' && (
                                <div className="flex w-full items-center gap-2 animate-in fade-in slide-in-from-bottom-4 duration-300">
                                    <input 
                                        type="tel" 
                                        placeholder="Start" 
                                        className={`flex-1 min-w-0 bg-white/20 border-2 focus:border-white/50 text-white placeholder-white/40 rounded-3xl py-3 h-14 sm:h-16 px-4 text-center text-xl sm:text-2xl font-mono outline-none transition-all ${shakeField === 'start' ? 'shake-input border-[#D11241]' : 'border-white/10'}`} 
                                        value={startId} 
                                        onChange={handleNumericInput(setStartId)} 
                                        maxLength={6} 
                                    />
                                    <span className="text-white/40 font-light text-2xl shrink-0 px-1">-</span>
                                    <input 
                                        type="tel" 
                                        placeholder="End" 
                                        className={`flex-1 min-w-0 bg-white/20 border-2 focus:border-white/50 text-white placeholder-white/40 rounded-3xl py-3 h-14 sm:h-16 px-4 text-center text-xl sm:text-2xl font-mono outline-none transition-all disabled:opacity-30 ${shakeField === 'end' ? 'shake-input border-[#D11241]' : 'border-white/10'}`} 
                                        value={endId} 
                                        onChange={handleNumericInput(setEndId)} 
                                        disabled={startId.length < 3} 
                                        maxLength={6} 
                                    />
                                </div>
                            )}

                            {!isCitationMode && mode === 'street' && (
                                <div className="relative w-full animate-in fade-in slide-in-from-bottom-4 duration-300">
                                    <input 
                                        list="streets" 
                                        placeholder="Search Street Name..." 
                                        className={`w-full bg-white/20 border-2 focus:border-white/50 text-white placeholder-white/40 rounded-3xl py-3 h-14 sm:h-16 px-4 sm:px-6 text-lg font-medium outline-none transition-all ${shakeField === 'street' ? 'shake-input border-[#D11241]' : 'border-white/10'}`} 
                                        value={streetQuery} 
                                        onChange={(e) => setStreetQuery(e.target.value)} 
                                    />
                                    <datalist id="streets">
                                        {streets.map(s => <option key={s} value={s} />)}
                                    </datalist>
                                    <div className="absolute right-5 top-1/2 -translate-y-1/2 text-white/40 pointer-events-none">
                                        <Search size={20} />
                                    </div>
                                </div>
                            )}

                            {isCitationMode && mode === 'ticket' && (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-300 flex flex-col items-center gap-4 w-full">
                                    <div className="flex items-center gap-2 w-full">
                                        <input 
                                            type="tel" 
                                            placeholder="Ticket Number" 
                                            className={`flex-1 min-w-0 bg-white/20 border-2 focus:border-white/50 text-white placeholder-white/40 rounded-3xl py-3 h-14 sm:h-16 px-4 text-center text-xl sm:text-2xl font-mono outline-none transition-all ${shakeField === 'ticket' ? 'shake-input border-[#D11241]' : 'border-white/10'}`} 
                                            value={ticketNum} 
                                            onChange={handleTicketInput} 
                                            maxLength={9} 
                                        />
                                        <button 
                                            onClick={() => setShowBarcodeScanner(true)}
                                            className="w-14 sm:w-16 h-14 sm:h-16 flex items-center justify-center rounded-3xl bg-white/20 border-2 border-white/10 hover:bg-white/30 text-white transition-all active:scale-95 flex-shrink-0"
                                            title="Scan Barcode"
                                        >
                                            <ScanBarcode size={24} />
                                        </button>
                                    </div>
                                    {ticketNum.length > 3 && (
                                        <div className="flex gap-2 w-full px-4 slide-in-up">
                                            {navigator.share && (
                                                <button 
                                                    onClick={handleCitationShare} 
                                                    className="flex-1 py-2.5 bg-white/10 rounded-xl hover:bg-white/20 transition-colors text-xs font-bold flex items-center justify-center gap-2 active:scale-95"
                                                >
                                                    <Share2 size={14} /> Share
                                                </button>
                                            )}
                                            <button 
                                                onClick={handleCitationCopy} 
                                                className="flex-1 py-2.5 bg-white/10 rounded-xl hover:bg-white/20 transition-colors text-xs font-bold flex items-center justify-center gap-2 active:scale-95"
                                            >
                                                {copyFeedback ? <CheckCircle size={14} className="text-green-400"/> : <Copy size={14} />}
                                                {copyFeedback || "Copy Link"}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {isCitationMode && mode === 'plate' && (
                                <div className="flex flex-col items-center w-full space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-300">
                                    <div className="flex items-center gap-2 w-full">
                                        <div className="relative w-[80px] flex-shrink-0">
                                            <select 
                                                value={plateState} 
                                                onChange={(e) => setPlateState(e.target.value)} 
                                                className="w-full bg-white/20 border-2 border-white/10 focus:border-white/50 text-white rounded-3xl py-3 h-14 sm:h-16 px-2 text-center text-base sm:text-lg font-bold appearance-none outline-none transition-all"
                                            >
                                                {US_STATES.map(s => <option key={s} value={s} className="text-black">{s}</option>)}
                                            </select>
                                            <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-white/60">â¼</div>
                                        </div>
                                        <input 
                                            type="text" 
                                            placeholder="PLATE #" 
                                            className={`flex-1 min-w-0 bg-white/20 border-2 focus:border-white/50 text-white placeholder-white/40 rounded-3xl py-3 h-14 sm:h-16 px-4 text-center text-xl sm:text-xl font-mono uppercase outline-none transition-all ${shakeField === 'plate' ? 'shake-input border-[#D11241]' : 'border-white/10'}`} 
                                            value={plateNum} 
                                            onChange={(e) => setPlateNum(e.target.value.toUpperCase())} 
                                        />
                                        <button 
                                            onClick={handleCameraClick}
                                            disabled={isScanning}
                                            className={`w-14 sm:w-16 h-14 sm:h-16 flex items-center justify-center rounded-3xl bg-white/20 border-2 border-white/10 hover:bg-white/30 text-white transition-all active:scale-95 flex-shrink-0 ${isScanning ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            title="Scan Plate"
                                        >
                                            {isScanning ? <Loader2 size={24} className="animate-spin" /> : <Camera size={24} />}
                                        </button>
                                    </div>
                                    {plateNum.length > 2 && (
                                        <div className="flex gap-2 w-full px-4 slide-in-up">
                                            {navigator.share && (
                                                <button 
                                                    onClick={handleCitationShare} 
                                                    className="flex-1 py-2.5 bg-white/10 rounded-xl hover:bg-white/20 transition-colors text-xs font-bold flex items-center justify-center gap-2 active:scale-95"
                                                >
                                                    <Share2 size={14} /> Share
                                                </button>
                                            )}
                                            <button 
                                                onClick={handleCitationCopy} 
                                                className="flex-1 py-2.5 bg-white/10 rounded-xl hover:bg-white/20 transition-colors text-xs font-bold flex items-center justify-center gap-2 active:scale-95"
                                            >
                                                {copyFeedback ? <CheckCircle size={14} className="text-green-400"/> : <Copy size={14} />}
                                                {copyFeedback || "Copy Link"}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {error && (
                            <div className="bg-[#D11241]/20 border border-[#D11241] rounded-2xl p-3 text-center slide-in-down">
                                <p className="text-white text-sm font-semibold flex items-center justify-center gap-2">
                                    <AlertTriangle size={16} /> {error}
                                </p>
                            </div>
                        )}

                        {/* Recent Searches */}
                        {!isCitationMode && recent.length > 0 && (
                            <div className="space-y-2 slide-in-up">
                                <div className="flex items-center justify-between px-2">
                                    <h3 className="text-white/60 text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                                        <History size={16} /> Recent
                                    </h3>
                                    <button 
                                        onClick={() => { clearRecent(); vibrate(10); }} 
                                        className="text-white/40 hover:text-white/60 text-xs flex items-center gap-1 transition-colors"
                                    >
                                        <Trash2 size={14} /> Clear
                                    </button>
                                </div>
                                <div className="space-y-1 max-h-40 overflow-y-auto hide-scroll">
                                    {recent.slice(0, 5).map((search, idx) => (
                                        <RecentSearchItem 
                                            key={idx} 
                                            search={search} 
                                            onSelect={handleRecentSelect}
                                            onRemove={(s) => {
                                                const updated = recent.filter(r => r.query !== s.query);
                                                storage.set(CONFIG.STORAGE_KEYS.RECENT, updated);
                                                vibrate(10);
                                            }}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Favorites */}
                        {!isCitationMode && favorites.length > 0 && (
                            <div className="space-y-2 slide-in-up" style={{ animationDelay: '0.1s' }}>
                                <h3 className="text-white/60 text-sm font-bold uppercase tracking-wider flex items-center gap-2 px-2">
                                    <Star size={16} className="text-yellow-500 fill-yellow-500" /> Favorites
                                </h3>
                                <div className="space-y-1 max-h-40 overflow-y-auto hide-scroll">
                                    {favorites.slice(0, 5).map((fav) => (
                                        <FavoriteItem 
                                            key={fav.id} 
                                            favorite={fav} 
                                            onSelect={handleFavoriteSelect}
                                            onRemove={(id) => { removeFavorite(id); vibrate(10); }}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                <div className="flex-grow flex flex-col items-center justify-start pt-8 relative pb-32">
                    <div className="relative flex justify-center items-center">
                        <div className="absolute w-48 h-48 sm:w-64 sm:h-64 border border-white/5 rounded-full pointer-events-none" />
                        <div className="absolute w-36 h-36 sm:w-48 sm:h-48 border border-white/10 rounded-full pointer-events-none" />
                        <div className={`circle-transition ${isExpanding ? 'expanding' : ''} ${!isExpanding && view !== 'search' && !isCitationMode ? 'closing' : ''}`} />

                        {loading && !isExpanding && (
                            <div className="absolute -top-24 sm:-top-20 left-0 right-0 flex justify-center z-40 px-6">
                                <div className="bg-[#003B71]/80 backdrop-blur-md border border-white/10 p-3 rounded-2xl max-w-xs text-center animate-pulse slide-in-down">
                                    <div className="flex justify-center mb-1">
                                        <CloudOff className="text-white/60" size={20} />
                                    </div>
                                    <p className="text-white/80 text-xs font-medium leading-relaxed">
                                        Connecting to free-tier backend...<br/>
                                        <span className="text-white/50">This may take up to 50s on first use.</span>
                                    </p>
                                </div>
                            </div>
                        )}

                        <button 
                            onClick={handleSearch} 
                            disabled={loading}
                            className="group relative w-32 h-32 sm:w-40 sm:h-40 rounded-full bg-white shadow-[0_0_40px_rgba(255,255,255,0.15)] hover:shadow-[0_0_60px_rgba(255,255,255,0.3)] transition-all duration-300 active:scale-95 flex items-center justify-center z-30 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <div className="absolute inset-1 rounded-full border-4 border-double border-[#003B71]/10 group-hover:border-[#003B71]/30 transition-colors" />
                            <div className="flex flex-col items-center text-[#003B71]">
                                {loading && !isExpanding ? (
                                    <RotateCw className="animate-spin" size={32} />
                                ) : (
                                    <>
                                        {isCitationMode ? <Search size={32} strokeWidth={2.5} className="sm:hidden" /> : <Search size={32} strokeWidth={2.5} className="sm:hidden" />}
                                        {isCitationMode ? <Search size={40} strokeWidth={2.5} className="hidden sm:block" /> : <Search size={40} strokeWidth={2.5} className="hidden sm:block" />}
                                        <span className="text-xs sm:text-sm font-black uppercase tracking-widest mt-1">
                                            {isCitationMode ? 'Lookup' : 'Find'}
                                        </span>
                                    </>
                                )}
                            </div>
                        </button>
                    </div>

                    <button 
                        onClick={toggleCitationMode}
                        className="mt-8 flex items-center gap-2 bg-white/10 hover:bg-white/20 px-6 py-3 rounded-xl backdrop-blur-md transition-all active:scale-95 border border-white/10 group z-30"
                    >
                        {isCitationMode ? <MapIcon size={20} className="text-white/80 group-hover:text-white" /> : <FileText size={20} className="text-white/80 group-hover:text-white" />}
                        <div className="text-left">
                            <span className="block text-[10px] uppercase font-bold text-white/60">Switch To</span>
                            <span className="block font-bold text-sm text-white group-hover:text-white transition-colors">
                                {isCitationMode ? "Space Locator" : "Citation Portal"}
                            </span>
                        </div>
                    </button>
                </div>
            </main>

            <div className={`fixed bottom-6 left-0 right-0 text-center z-10 transition-opacity duration-300 ${view === 'results' ? 'opacity-0' : 'opacity-80'}`}>
                <div className="flex flex-col items-center gap-4 text-sm" style={{ borderColor: 'rgba(255,255,255,0.2)', color: 'rgba(255,255,255,0.7)' }}>
                    <div className="flex items-center gap-3">
                        <span className="font-medium">Built by <span style={{ color: '#fff' }}>William Dugann</span></span>
                        <span>|</span>
                        <a href="https://github.com/dugann" className="hover:text-white transition-colors p-1" target="_blank" rel="noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg>
                        </a>
                        <a href="https://www.linkedin.com/in/dugann/" className="transition-colors p-1 hover:text-white" style={{ color: 'white' }} target="_blank" rel="noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
                        </a>
                    </div>
                </div>
            </div>

            {/* Results Panel */}
            <div className={`fixed inset-x-0 bottom-0 z-30 bg-slate-200 text-[#003B71] rounded-t-[2.5rem] shadow-2xl transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) flex flex-col safe-bottom ${view === 'results' ? 'translate-y-0 h-[85vh]' : 'translate-y-full h-[85vh]'}`}>
                <div className="px-6 py-4 flex items-center justify-between bg-[#003B71] rounded-t-[2.5rem] sticky top-0 z-40 shadow-md">
                    <button 
                        onClick={handleNewSearch} 
                        className="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-xl transition-colors text-sm font-bold active:scale-95"
                    >
                        <RotateCw size={18} /> New Search
                    </button>
                    <div className="text-right">
                        <span className="block font-bold text-white text-xl leading-none">{results.length}</span>
                        <span className="text-[10px] text-white/60 font-bold uppercase tracking-wider">Results</span>
                    </div>
                </div>
                
                <div className="flex-1 overflow-y-auto hide-scroll bg-slate-200">
                    {loading ? (
                        <LoadingSkeleton />
                    ) : results.length === 0 ? (
                        <EmptyState 
                            message="No results found. Try adjusting your search." 
                            icon={Search}
                            action={
                                <button 
                                    onClick={handleNewSearch}
                                    className="px-6 py-2.5 bg-[#003B71] text-white rounded-xl font-bold active:scale-95 transition-all"
                                >
                                    New Search
                                </button>
                            }
                        />
                    ) : (
                        <div className="p-4">
                            {dataDate && (
                                <div className="mb-4 p-3 bg-blue-50/80 border border-blue-200 rounded-xl flex items-start gap-3 shadow-sm slide-in-up">
                                    <Info className="text-blue-600 shrink-0 mt-0.5" size={18} />
                                    <p className="text-xs text-blue-800 leading-relaxed font-medium">
                                        These results are dependent on the accuracy of City maintained records which were last updated on <span className="font-bold">{dataDate}</span>.
                                    </p>
                                </div>
                            )}
                            <div className={view === 'results' ? 'fade-enter-active' : 'fade-enter'}>
                                {results.map((item, idx) => ( 
                                    <ResultItem 
                                        key={idx} 
                                        item={item} 
                                        onFavorite={(fav) => {
                                            if (isFavorite(fav.id)) {
                                                removeFavorite(fav.id);
                                                showToast('Removed from favorites', 'info');
                                            } else {
                                                addFavorite(fav);
                                                showToast('Added to favorites', 'success');
                                            }
                                        }}
                                        isFavorite={isFavorite(item.ids.join('-'))}
                                    /> 
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            </div>

            {/* Settings Modal */}
            {showSettingsModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 fade-in">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setShowSettingsModal(false)} />
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm relative z-10 slide-in-up text-black">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-[#003B71] flex items-center gap-2">
                                <Settings size={24} /> Settings
                            </h2>
                            <button 
                                onClick={() => setShowSettingsModal(false)} 
                                className="p-1 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"
                            >
                                <X size={20} className="text-gray-500" />
                            </button>
                        </div>

                        <div className="space-y-4">
                            <div className="bg-gray-50 rounded-2xl p-4">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <Zap size={18} className="text-[#003B71]" />
                                        <span className="font-bold text-sm">Performance</span>
                                    </div>
                                </div>
                                <p className="text-xs text-gray-600">
                                    {isOnline ? 
                                        <span className="flex items-center gap-2"><Wifi size={14} className="text-green-500" /> Connected</span> : 
                                        <span className="flex items-center gap-2"><WifiOff size={14} className="text-red-500" /> Offline</span>
                                    }
                                </p>
                            </div>

                            <div className="bg-gray-50 rounded-2xl p-4">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <History size={18} className="text-[#003B71]" />
                                        <span className="font-bold text-sm">Data</span>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            clearRecent();
                                            showToast('Recent searches cleared', 'success');
                                            vibrate(10);
                                        }}
                                        className="text-xs text-red-600 hover:text-red-700 font-bold"
                                    >
                                        Clear Recent
                                    </button>
                                </div>
                                <p className="text-xs text-gray-600">
                                    {recent.length} recent searches â¢ {favorites.length} favorites
                                </p>
                            </div>

                            {dataDate && (
                                <div className="bg-blue-50 rounded-2xl p-4 border border-blue-200">
                                    <div className="flex items-center gap-2 mb-1">
                                        <Info size={18} className="text-blue-600" />
                                        <span className="font-bold text-sm text-blue-900">Data Source</span>
                                    </div>
                                    <p className="text-xs text-blue-700">
                                        IndyGIS metered-parking layer
                                    </p>
                                    <p className="text-xs text-blue-600 mt-1">
                                        Last updated: <span className="font-bold">{dataDate}</span>
                                    </p>
                                </div>
                            )}
                        </div>

                        <button 
                            onClick={() => setShowInfoModal(true)} 
                            className="w-full mt-6 py-3 bg-[#003B71] text-white font-bold rounded-xl active:scale-95 transition-transform flex items-center justify-center gap-2"
                        >
                            <Info size={18} /> About Open Curb
                        </button>
                    </div>
                </div>
            )}

            {/* Info Modal */}
            {showInfoModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 fade-in">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setShowInfoModal(false)} />
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm relative z-10 slide-in-up text-black">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-[#003B71]">System Intel</h2>
                            <button 
                                onClick={() => setShowInfoModal(false)} 
                                className="p-1 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"
                            >
                                <X size={20} className="text-gray-500" />
                            </button>
                        </div>
                        
                        <p className="text-gray-600 text-sm leading-relaxed mb-6">
                            This utility bridges a direct connection to Indy's Open Data MapServer (Transportation Layer 14) for field asset verification.
                        </p>
                        
                        <div className="flex items-center gap-3 bg-blue-50 p-3 rounded-xl mb-4 border border-blue-100">
                            <div className="bg-[#003B71] p-2 rounded-full text-white">
                                <User size={16} />
                            </div>
                            <div className="flex-1">
                                <p className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Designed By</p>
                                <p className="text-[#003B71] font-bold text-sm">William Dugann</p>
                            </div>
                            <div className="flex gap-2">
                                <a href="https://github.com/dugann" target="_blank" rel="noreferrer" className="text-[#003B71]/70 hover:text-[#003B71] transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg>
                                </a>
                                <a href="https://www.linkedin.com/in/dugann/" target="_blank" rel="noreferrer" className="text-[#003B71]/70 hover:text-[#003B71] transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
                                </a>
                            </div>
                        </div>
                        
                        <div className="bg-gray-50 rounded-2xl p-4 mb-4">
                            <p className="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">Data Source</p>
                            <p className="text-[#003B71] font-mono text-xs">IndyGIS :: metered-parking</p>
                        </div>
                        
                        <button 
                            onClick={() => setShowInfoModal(false)} 
                            className="w-full py-3 bg-[#003B71] text-white font-bold rounded-xl active:scale-95 transition-transform"
                        >
                            Dismiss
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
}

const container = document.getElementById('root');
const root = createRoot(container);
root.render(<App />);
    </script>
</body>
</html>
